#!/bin/bash
#

# Functions
ok() { 
    echo -e '\e[32m'$1'\e[m'; 
}

die() { 
    echo -e '\e[1;31m'$1'\e[m'; exit 1; 
}

# Sanity check
if [[ $(id -g) != "0" ]] ; then
    die "??? Script must be run as root."
fi

if [[  ! -e /dev/net/tun ]] ; then 
    die "??? TUN/TAP device is not available."
fi


dpkg -l openvpn > /dev/null 2>&1
if [[ $? -eq 0 ]]; then
   die "??? OpenVPN is already installed."
fi

# Install openvpn
ok "??? apt-get update"
apt-get update -q > /dev/null 2>&1
ok "??? apt-get install openvpn curl openssl"
apt-get install openvpn easy-rsa > /dev/null 2>&1
gunzip -c /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz > /etc/openvpn/server.conf



#insert server ip / port / route
while getopts n:p:r: option
do
case "${option}"
in
n) SER_IP=${OPTARG};;
p) SER_P=${OPTARG};;
r) R=${OPTARG};;
esac
done
echo $SER_IP
echo $SER_P
echo $R


# Generate Server Config
ok "??? Generating Server Config"


cat > /etc/openvpn/server.conf <<EOF
server $SER_IP 255.255.255.0
verb 3
duplicate-cn
ca ca.crt
cert server.crt
key server.key
dh dh2048.pem
ifconfig-pool-persist ipp.txt
comp-lzo

keepalive 10 120
persist-key
persist-tun
comp-lzo
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
push "route $R 255.255.255.0"
push "route $R 255.255.255.0"

user nobody
group nogroup

proto udp
port $SER_P
dev tun
status openvpn-status.log
EOF

echo 1 > /proc/sys/net/ipv4/ip_forward
sed -i 's|#net.ipv4.ip_forward=1|net.ipv4.ip_forward=1|' /etc/sysctl.conf


# Generate CA Config
ok "??? Generating CA Config"
cp -r /usr/share/easy-rsa/ /etc/openvpn
mkdir /etc/openvpn/easy-rsa/keys
cat > /etc/openvpn/easy-rsa/vars <<EOF
export EASY_RSA="`pwd`"
export OPENSSL="openssl"
export PKCS11TOOL="pkcs11-tool"
export GREP="grep"
export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
export KEY_DIR="$EASY_RSA/keys"
echo NOTE: If you run ./clean-all, I will be doing a rm -rf on $KEY_DIR
export PKCS11_MODULE_PATH="dummy"
export PKCS11_PIN="dummy"
export KEY_SIZE=2048
export CA_EXPIRE=3650
export KEY_EXPIRE=3650
export KEY_COUNTRY="SY"
export KEY_PROVINCE="LA"
export KEY_CITY="LATAKIA"
export KEY_ORG="JABLEH"
export KEY_EMAIL="alisoulimansaid.1993@gmail.com"
export KEY_OU="MyOrganizationalUnit"
export KEY_NAME="server"
EOF
openssl dhparam -out /etc/openvpn/dh2048.pem 2048
cd /etc/openvpn/easy-rsa/
 source /etc/openvpn/easy-rsa/vars

/etc/openvpn/easy-rsa/clean-all
/etc/openvpn/easy-rsa/pkitool --initca
/etc/openvpn/easy-rsa/pkitool --server server
#./pkitool --server server
cp /etc/openvpn/easy-rsa/keys/{server.crt,server.key,ca.crt} /etc/openvpn
ls /etc/openvpn

# Restart Service
ok "??? service openvpn restart"
service openvpn restart
service openvpn status

ok "??? All done!"